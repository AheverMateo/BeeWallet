import { logger } from "../../config/logger.js";
import { resFail, resSuccess } from "../../config/utils/response.js";
import InvestmentModel from "./schema.js";
import { TNA, calculateEarnedInterests, getFinishDate } from "./utils.js";

/**
 * Allows you to create an investment.
 * must be received in the request body:
 *    - amount: number = amount to invest
 *    -
 * @param {*} req
 * @param {*} res
 */
async function createInvestment(req, res) {
   try {
      const { amount, days, walletId } = req.body;

      const earnedInterests = calculateEarnedInterests(amount, days);
      const finishDate = getFinishDate(days);

      const payload = { amount, days, tna: TNA, earnedInterests, finishDate, walletId };

      const investment = new InvestmentModel(payload);

      const investmentSaved = investment.save();

      if (!investmentSaved) {
         return resFail(res, 400, "The investment could not be made");
      }

      return resSuccess(res, 201, "Investment made successfully", investmentSaved);
   } catch (error) {
      logger.error(`${error.stack}`);
      return res.status(500).json({ success: false, message: "Internal Server Error" });
   }
}

/**
 * Allows get a Investment by ID
 * The ID must be received by params
 * /investments/:id
 * @param {*} req
 * @param {*} res
 */
async function getInvestment(req, res) {
   const { id } = req.params;
   try {
      const investment = await InvestmentModel.findById(id);
      if (!investment) {
         return resFail(res, 404, "Investment not found");
      }
      resSuccess(res, 200, "Investment found", investment);
   } catch (error) {
      logger.error(`${error.stack}`);
      return res.status(500).json({ success: false, message: "Internal Server Error" });
   }
}

/**
 * Allows get all Investment generated by a wallet
 * The ID must be received by params
 * /investments/wallet/:id
 * @param {*} req
 * @param {*} res
 */
async function getAllInvestmentByWallet(req, res) {
   // TODO: implement get all Investment by wallet user
}

/**
 * Allows simulate a Investment
 * must be received in the request:
 *    - amount: number = amount to invest
 *    - days: number = days to invest
 * @param {*} req
 * @param {*} res
 */
function simulateInvestment(req, res) {
   try {
      const { amount, days } = req.body;

      console.log(req.body);

      const earnedInterests = calculateEarnedInterests(amount, days);
      const finishDate = getFinishDate(days);

      console.log(earnedInterests);
      const payload = { amount, days, tna: TNA, earnedInterests, finishDate };

      return resSuccess(res, 200, "Investment simulation", payload);
   } catch (error) {
      logger.error(`${error.stack}`);
      return res.status(500).json({ success: false, message: "Internal Server Error" });
   }
}

const investmentController = {
   createInvestment,
   getAllInvestmentByWallet,
   getInvestment,
   simulateInvestment,
};

export default investmentController;
